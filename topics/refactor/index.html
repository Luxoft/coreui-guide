



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="guide to the core ui architecture for QML driven projects">
      
      
      
        <meta name="author" content="Juergen Ryannel">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Refactoring - QML Core UI</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Ubuntu+Mono&display=fallback">
        <style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#micro-refactorings" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="QML Core UI" class="md-header-nav__button md-logo">
          
            <i class="md-icon">bookmark</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              QML Core UI
            </span>
            <span class="md-header-nav__topic">
              
                Refactoring
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/Luxoft/qml-coreui-guide/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link">
        Overview
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../guide/whatis/" class="md-tabs__link">
          Guide
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../foundations/" class="md-tabs__link md-tabs__link--active">
          Topics
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../admin/intro/" class="md-tabs__link">
          Admin
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../extensions/overview/" class="md-tabs__link">
          Extensions
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../resources/" class="md-tabs__link">
          Resources
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="QML Core UI" class="md-nav__button md-logo">
      
        <i class="md-icon">bookmark</i>
      
    </a>
    QML Core UI
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/Luxoft/qml-coreui-guide/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/whatis/" title="What is Core UI" class="md-nav__link">
      What is Core UI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/install/" title="Install" class="md-nav__link">
      Install
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/start/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/cookbook/" title="CookBook" class="md-nav__link">
      CookBook
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/examples/" title="Examples" class="md-nav__link">
      Examples
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Topics
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Topics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../foundations/" title="Foundations" class="md-nav__link">
      Foundations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../blocks/" title="Building Blocks" class="md-nav__link">
      Building Blocks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../controls/" title="Controls" class="md-nav__link">
      Controls
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fslayout/" title="Filesystem layout" class="md-nav__link">
      Filesystem layout
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extensions/" title="Extensions" class="md-nav__link">
      Extensions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../layouts/" title="Layouts" class="md-nav__link">
      Layouts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../prototyping/" title="Protoyping" class="md-nav__link">
      Protoyping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../services/" title="Services" class="md-nav__link">
      Services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../testing/" title="Testing" class="md-nav__link">
      Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../uilayer/" title="UI Layer" class="md-nav__link">
      UI Layer
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Refactoring
      </label>
    
    <a href="./" title="Refactoring" class="md-nav__link md-nav__link--active">
      Refactoring
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture-kpis" class="md-nav__link">
    Architecture KPIs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kpi-number-of-singletons-used-in-edge-nodes" class="md-nav__link">
    KPI - Number of singletons used in edge nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kpi-relation-of-kind-of-components-count-vs-the-classic-component-count" class="md-nav__link">
    KPI - Relation of kind of components count vs the classic component count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kpi-number-of-harmful-imports-per-kind-of-component" class="md-nav__link">
    KPI - Number of harmful imports per kind of component
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#micro-refactoring-cookbook" class="md-nav__link">
    Micro Refactoring Cookbook
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recipe-stop-leaking-object-internals-from-singletons" class="md-nav__link">
    Recipe: Stop leaking object internals from singletons
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-push-singletons-up" class="md-nav__link">
    Recipe: Push singletons up
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-eliminate-singletons" class="md-nav__link">
    Recipe: Eliminate singletons
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-extract-harmful-dependency-conditions" class="md-nav__link">
    Recipe: Extract harmful dependency conditions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-convert-component-to-kinds" class="md-nav__link">
    Recipe: Convert Component to Kinds
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-extract-a-store" class="md-nav__link">
    Recipe: Extract a Store
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../styles/" title="Styles" class="md-nav__link">
      Styles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../runtime/" title="Runtime & Modules" class="md-nav__link">
      Runtime & Modules
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../data/" title="Exposing Data to QML" class="md-nav__link">
      Exposing Data to QML
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../workflow/" title="Design Work Flow" class="md-nav__link">
      Design Work Flow
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Admin
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Admin
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../admin/intro/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../admin/start/" title="Quick Start" class="md-nav__link">
      Quick Start
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../admin/concepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../admin/build/" title="Building" class="md-nav__link">
      Building
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../admin/dev/" title="Developing" class="md-nav__link">
      Developing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../admin/projects/" title="Project Creation" class="md-nav__link">
      Project Creation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../admin/reference/" title="Reference" class="md-nav__link">
      Reference
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Extensions
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Extensions
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../extensions/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Resources
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Resources
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../resources/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture-kpis" class="md-nav__link">
    Architecture KPIs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kpi-number-of-singletons-used-in-edge-nodes" class="md-nav__link">
    KPI - Number of singletons used in edge nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kpi-relation-of-kind-of-components-count-vs-the-classic-component-count" class="md-nav__link">
    KPI - Relation of kind of components count vs the classic component count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kpi-number-of-harmful-imports-per-kind-of-component" class="md-nav__link">
    KPI - Number of harmful imports per kind of component
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#micro-refactoring-cookbook" class="md-nav__link">
    Micro Refactoring Cookbook
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recipe-stop-leaking-object-internals-from-singletons" class="md-nav__link">
    Recipe: Stop leaking object internals from singletons
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-push-singletons-up" class="md-nav__link">
    Recipe: Push singletons up
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-eliminate-singletons" class="md-nav__link">
    Recipe: Eliminate singletons
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-extract-harmful-dependency-conditions" class="md-nav__link">
    Recipe: Extract harmful dependency conditions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-convert-component-to-kinds" class="md-nav__link">
    Recipe: Convert Component to Kinds
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-extract-a-store" class="md-nav__link">
    Recipe: Extract a Store
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Luxoft/qml-coreui-guide/edit/master/docs/topics/refactor.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="micro-refactorings">Micro - Refactorings</h1>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This material is work in progress and will change!</p>
</div>
<p>Refactoring shall provide the reader with insights how to re-factor slowly an existing user interface architecture toward the CoreUI architecture by applying a series of micro-re-factorings.</p>
<p>A micro-refactoring is a small rewrite of source code which fits mentally inside the developers head. This is important to ensure the developer is aware about any side-effects and can fix these before committing.</p>
<p>We must avoid a large refactoring where the developer require days before the software is stable again. Ideally the software stays stable all the time during refactoring.</p>
<p>Refactoring must be planned and executed over time. A larger user interface project can not be moved over night into a new direction, especially when many developer participate and still defects and features are on the road-map. To ensure the team has an understanding of the healthiness of the architecture certain KPI must be introduced and measured over time.</p>
<h2 id="architecture-kpis">Architecture KPIs</h2>
<p>A KPI (key performance indicator) provides high level insights about the healthiness of the software architecture. To understand the KPIs presented, we need to understand that the UI is a tree with a root node and edge nodes and many nodes in between. Ideally the outer nodes are clean from difficult dependencies, whereas the inner notes can depend on those dependencies but even here ideally these dependencies are extracted into another set of objects, the stores.</p>
<p>In general, we have stores, views, panels and controls. The controls form the edge nodes of our UI tree. Right below the controls are the panels. The panels care the most UI load as they use semantic free controls to introduce application semantic. Below the panels, sit the views which bring together the UI surface. Views are part of the UI that depend on data providers which are the stores. The stores encapsulate the application business logic and interface to the platform services. Based on this description we can start to extract some KPIs.</p>
<p>At first, we need to identify the complex dependencies. These are dependencies which make unit testing more painful. These harmful dependencies can be a module which uses a network service or a global object introducing global state or a rendering node which introduces certain hardware dependencies to the UI. We must ensure our goal to decompose the UI and unit test of each component must not be compromised.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Ensure UI can be decomposed and run independent and the testability is guaranteed.</p>
</div>
<h3 id="kpi-number-of-singletons-used-in-edge-nodes">KPI - Number of singletons used in edge nodes</h3>
<p>Measure the number of singletons used in edge nodes and above (2nd level edges). This number indicates how much these nodes depend on global state. This number should go down over time.</p>
<h3 id="kpi-relation-of-kind-of-components-count-vs-the-classic-component-count">KPI - Relation of kind of components count vs the classic component count</h3>
<p>This measures the relation between the identified and converted kind of components to the uncategorized components. The goal is to ensure over time the number of components with unmanaged dependencies are reduced and the converted components can be checked for harmful imports.</p>
<h3 id="kpi-number-of-harmful-imports-per-kind-of-component">KPI - Number of harmful imports per kind of component</h3>
<p>This counts the number of harmful imports per kind of component. Ideally the controls and panels will reduce the number of harmful components and most harmful imports will be isolated inside the stores.</p>
<h2 id="micro-refactoring-cookbook">Micro Refactoring Cookbook</h2>
<p>Refactoring is a disciplined technique for restructuring an existing body of code, altering its internal structure without changing its external behavior.</p>
<blockquote>
<p>Its heart is a series of small behavior preserving transformations. Each transformation (called a "refactoring") does little, but a sequence of these transformations can produce a significant restructuring. Since each refactoring is small, it's less likely to go wrong. The system is kept fully working after each refactoring, reducing the chances that a system can get seriously broken during the restructuring.
Martin Fowler (<a href="https://refactoring.com">https://refactoring.com</a>)</p>
</blockquote>
<h3 id="recipe-stop-leaking-object-internals-from-singletons">Recipe: Stop leaking object internals from singletons</h3>
<p>A singleton which exposes an object, opens the opportunity for anyone to navigate to the object internals. By this, open up the opportunities to any kind of cross-dependencies.</p>
<p>Take a look on the example below. Assume that there is a singleton which expose an object</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// HelperSingleton.qml</span>
<span class="nx">QtObject</span> <span class="p">{</span>
    <span class="nx">property</span> <span class="nx">Item</span> <span class="nx">appWindow</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>The desired usage could be to allow others to control its window visibility.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// AppPanel.qml</span>
<span class="nx">Panel</span> <span class="p">{</span>
    <span class="nx">Button</span> <span class="p">{</span>
        <span class="k">text:</span> <span class="s2">&quot;Hide window&quot;</span>
        <span class="k">onClicked:</span> <span class="nx">HelperSingleton</span><span class="p">.</span><span class="nx">appWindow</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>But, it also allows others to expose the object in an evil way like an example below:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// EvilPanel.qml</span>
<span class="nx">Panel</span> <span class="p">{</span>
    <span class="nx">Button</span> <span class="p">{</span>
        <span class="k">text:</span> <span class="s2">&quot;Set Title of Window&quot;</span>
        <span class="k">onClicked:</span> <span class="nx">HelperSingleton</span><span class="p">.</span><span class="nx">appWindow</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">text</span> <span class="o">=</span> <span class="s2">&quot;A new title&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Now, the EvilPanel depends on the internal structure and even existence of internal UI types. And even worse, the developer of the AppWindow is not aware that someone is using the same API somewhere else. Hence, don't expose your object internals, and do not use other object's internals.</p>
<p>The point is, the user of a singleton could now navigate to the parents of the window, just to fulfill a single requirement.</p>
<blockquote>
<p>anything could happen, can happen</p>
</blockquote>
<p>To close down this object's leakage, we need to investigate how the object is meant to be used. Often, we see pattern in the usage. The patterns then need to be extracted into a function, and the function would then navigate the object.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// HelperSingleton.qml - improved
QtObject {
<span class="gd">-   property Item appWindow</span>
<span class="gi">+   readonly property Item __appWindow</span>

<span class="gi">+   function hideWindow() {</span>
<span class="gi">+       __appWindow.visible = false</span>
<span class="gi">+   }</span>

<span class="gi">+   function setWindowTitle(title) {</span>
<span class="gi">+       __appWindow.setTitle(title)</span>
<span class="gi">+   }</span>
}
</pre></div>
</td></tr></table>

<p>And better panels</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// AppPanel.qml - improved
Panel {
    Button {
        text: &quot;Hide window&quot;
<span class="gd">-       onClicked: HelperSingleton.appWindow.visible = false</span>
<span class="gi">+       onClicked: HelperSingleton.hideWindow()</span>
    }
}
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// EvilPanel.qml - improved
Panel {
    Button {
        text: &quot;Set Title of Window&quot;
<span class="gd">-       onClicked: HelperSingleton.appWindow.children[0].text = &quot;A new title&quot;</span>
<span class="gi">+       onClicked: HelperSingleton.setWindowTitle(&quot;A new title&quot;)</span>
    }
}
</pre></div>
</td></tr></table>

<p>Over time, we will be able to eliminate the object from the public interface and only allow users to use these functions. From now on, we can ensure there will be no new internals of this object will be leaked. And even better, we are now able to understand how users want to use the API. Additionally, by making the object's property become readonly will make sure that users will not be able to change the content of that object as well.</p>
<blockquote>
<p>Expose functions with meanings, not objects with internals</p>
</blockquote>
<h3 id="recipe-push-singletons-up">Recipe: Push singletons up</h3>
<p>When investigating the usage of certain singletons, usually they are found in a related code area. It seems that developers are too lazy to pass in these dependencies and rather find a shortcut of the relations.</p>
<p>Assuming that we have a panel which show a title and some content. The title shall present the current time and the content shall present the time but also be able to reset the current time.</p>
<p>The parent application panel, which holds both children panels.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// AppPanel.qml</span>
<span class="nx">Panel</span> <span class="p">{</span>
    <span class="nx">TitlePanel</span> <span class="p">{}</span>
    <span class="nx">ContentPanel</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>The title panel displays the current time.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// TitlePanel.qml</span>
<span class="kr">import</span> <span class="nx">service</span><span class="p">.</span><span class="nx">time</span> <span class="mf">1.0</span>

<span class="nx">Panel</span> <span class="p">{</span>
    <span class="nx">Label</span> <span class="p">{</span>
        <span class="k">text:</span> <span class="nx">Clock</span><span class="p">.</span><span class="nx">currentTime</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>The content panel will display the time and is allowed to reset the current time.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// ContentPanel.qml</span>
<span class="kr">import</span> <span class="nx">service</span><span class="p">.</span><span class="nx">time</span> <span class="mf">1.0</span>

<span class="nx">Panel</span> <span class="p">{</span>
    <span class="nx">Button</span> <span class="p">{</span>
        <span class="k">text:</span> <span class="nx">Clock</span><span class="p">.</span><span class="nx">currentTime</span>
        <span class="k">onClicked:</span> <span class="nx">Clock</span><span class="p">.</span><span class="nx">resetTime</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>We can revert this by looking at the singleton usage in a component and move the usage up to the root level.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// TitlePanel.qml
import service.time 1.0

Panel {
    id: root
<span class="gi">+   property string currentTime: Clock.currentTime</span>
    Label {
<span class="gd">-       text: Clock.currentTime</span>
<span class="gi">+       text: root.currentTime</span>
    }
}
</pre></div>
</td></tr></table>

<p>The same way can be applied to content panel</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// ContentPanel.qml
import service.time 1.0

Panel {
    id: root
<span class="gi">+   property string currentTime: Clock.currentTime</span>
<span class="gi">+   signal resetTime()</span>
<span class="gi">+   onResetTime: Clock.resetTime()</span>

    Button {
<span class="gd">-       text: Clock.currentTime</span>
<span class="gi">+       text: root.currentTime</span>
<span class="gd">-       onClicked: Clock.resetTime()</span>
<span class="gi">+       onClicked: root.resetTime()</span>
    }
}
</pre></div>
</td></tr></table>

<p>In the next step, we can then move the singleton onto the other side and pass it into the component.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// AppPanel.qml
<span class="gi">+ import service.time 1.0</span>

Panel {
    TitlePanel {
<span class="gi">+       currentTime: Clock.currentTime</span>
    }
    ContentPanel {
<span class="gi">+       currentTime: Clock.currentTime</span>
<span class="gi">+       onResetTime: Clock.resetTime()</span>
    }
}
</pre></div>
</td></tr></table>

<p>Now, we can eliminate the usage of the singletons in the children.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// TitlePanel.qml
<span class="gd">- import service.time 1.0</span>
Panel {
    id: root
<span class="gd">-   property string currentTime: Clock.currentTime</span>
<span class="gi">+   property string currentTime</span>
    Label {
        text: root.currentTime
    }
}
</pre></div>
</td></tr></table>

<p>And similar to the content panel</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// ContentPanel.qml
<span class="gd">- import service.time 1.0</span>
Panel {
    id: root
<span class="gd">-   property string currentTime: Clock.currentTime</span>
<span class="gi">+   property string currentTime</span>
    signal resetTime()
<span class="gd">-   onResetTime: Clock.resetTime()</span>

    Button {
        text: root.currentTime
        onClicked: root.resetTime()
    }
}
</pre></div>
</td></tr></table>

<p>Be aware that we are now able to remove the dependency on the <code>service.time</code> module and by this making the <code>TitlePanel</code> and <code>ContentPanel</code> easier to test as dependencies are now injected instead of directly implemented inside.</p>
<p>By doing this, we effectively push the singleton usage one level up. Normally, it is expected after several commits until we reach a level where several child components suddenly depend on the same information injected from the singleton. To effectively predict how many levels you need to push this dependency up, we would need to identify the node which creates the child nodes using the singleton. If we reach that point, there is no need for a singleton and we can convert the singleton into an instance of even eliminate it all together.</p>
<h3 id="recipe-eliminate-singletons">Recipe: Eliminate singletons</h3>
<p>A singleton normally shares global state, functionality and events. To eliminate this we need to find the common ancestor node from where we can inject the dependencies. For a share event, we often can just connect the signal with a state change on that level, for shared properties we could do similar. For common functionality we can connect a signal which bubbles up to a function being executed. Ideally the function is extracted into a store if its application business relevant.</p>
<p>So after we pushed the singleton up, we could now convert it to an instance, which acts like a small store.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// AppPanel.qml
<span class="gi">+ import service.time 1.0</span>

Panel {
<span class="gi">+   Clock {</span>
<span class="gi">+       id: clock</span>
<span class="gi">+   }</span>
    TitlePanel {
<span class="gd">-       currentTime: Clock.currentTime</span>
<span class="gi">+       currentTime: clock.currentTime</span>
    }
    ContentPanel {
<span class="gd">-       currentTime: Clock.currentTime</span>
<span class="gi">+       currentTime: clock.currentTime</span>

<span class="gd">-       onResetTime: Clock.resetTime()</span>
<span class="gi">+       onResetTime: clock.resetTime()</span>
    }
}
</pre></div>
</td></tr></table>

<p>Now that we have an instance, we can in our tests create and destroy this instance. Also when this UI portion is destroyed, the service instance will also be destroyed and does not use any resources.</p>
<p>To go a step forward we can even inject the service as a dependency.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// AppPanel.qml
<span class="gi">+ import service.time 1.0</span>

Panel {
<span class="gd">-   Clock {</span>
<span class="gd">-       id: clock</span>
<span class="gd">-   }</span>
<span class="gi">+   property Clock clock : Clock { }</span>
    TitlePanel {
        currentTime: clock.currentTime
    }
    ContentPanel {
        currentTime: clock.currentTime

        onResetTime: clock.resetTime()
    }
}
</pre></div>
</td></tr></table>

<p>This allows use to configure the dependency of the AppPanel and with this make it better testable.</p>
<h3 id="recipe-extract-harmful-dependency-conditions">Recipe: Extract harmful dependency conditions</h3>
<p>A harmful dependency is a dependency which breaks decomposition and testability by introducing (often indirect) not testable dependencies (e.g. network, hardware, global state).</p>
<p>For this to be eliminated we need to push the dependency up, by first moving the dependency out of the internal of the component to the root level of the component and in a second step injecting the dependency into the component form the outside. By this practically removing the dependency from that particular component.</p>
<p>The pattern is very similar to the removing a singleton refactoring. Assuming we have a station panel, which depends on a tuner service, to receive a list of stations and tune to the selected station.</p>
<p>In the first instance the panel instantiates the service directly and by this introduces a dependency to the service as also makes it harder for testing.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// StationPanel.qml</span>
<span class="kr">import</span> <span class="nx">service</span><span class="p">.</span><span class="nx">radio</span> <span class="mf">1.0</span>
<span class="nx">Panel</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="nx">TunerService</span> <span class="p">{</span>
        <span class="kd">id: service</span>
    <span class="p">}</span>
    <span class="nx">ListView</span> <span class="p">{</span>
        <span class="k">enabled:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">visible</span> <span class="o">&amp;&amp;</span> <span class="nx">service</span><span class="p">.</span><span class="nx">on</span>
        <span class="k">model:</span> <span class="nx">service</span><span class="p">.</span><span class="nx">stations</span>
        <span class="k">delegate:</span> <span class="nx">StationItem</span> <span class="p">{</span>
            <span class="k">title:</span> <span class="nx">model</span><span class="p">.</span><span class="nx">name</span>
            <span class="k">icon:</span> <span class="nx">model</span><span class="p">.</span><span class="nx">icon</span>
            <span class="k">onClicked:</span> <span class="nx">service</span><span class="p">.</span><span class="nx">tune</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">stationID</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>We use the same strategy as before to move the dependency to the root level, to be able in a later step to inject it.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// StationPanel.qml</span>
<span class="kr">import</span> <span class="nx">service</span><span class="p">.</span><span class="nx">radio</span> <span class="mf">1.0</span>
<span class="nx">Panel</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="nx">property</span> <span class="nx">TunerService</span> <span class="nx">service</span>
    <span class="nx">ListView</span> <span class="p">{</span>
        <span class="k">enabled:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">visible</span> <span class="o">&amp;&amp;</span> <span class="nx">root</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">on</span>
        <span class="k">model:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">stations</span>
        <span class="k">delegate:</span> <span class="nx">StationItem</span> <span class="p">{</span>
            <span class="k">title:</span> <span class="nx">model</span><span class="p">.</span><span class="nx">name</span>
            <span class="k">icon:</span> <span class="nx">model</span><span class="p">.</span><span class="nx">icon</span>
            <span class="k">onClicked:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">tune</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">stationID</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>This step splits the dependency to the individual parts to be able to remove the service dependency and by this make this component more testable.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We use the type <code>Model</code> which was registered as <code>qmlRegisterUncreatableType</code> to be able to define a object derived from <code>QAbstractItemModel</code> shall be used here.</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// StationPanel.qml</span>
<span class="nx">Panel</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="nx">property</span> <span class="nx">Model</span> <span class="nx">stations</span>
    <span class="nx">property</span> <span class="nx">bool</span> <span class="nx">on</span>
    <span class="nx">signal</span> <span class="nx">tune</span><span class="p">(</span><span class="nx">string</span> <span class="nx">stationID</span><span class="p">)</span>
    <span class="nx">ListView</span> <span class="p">{</span>
        <span class="k">enabled:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">on</span>
        <span class="k">model:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">stations</span>
        <span class="k">delegate:</span> <span class="nx">StationItem</span> <span class="p">{</span>
            <span class="k">title:</span> <span class="nx">model</span><span class="p">.</span><span class="nx">name</span>
            <span class="k">icon:</span> <span class="nx">model</span><span class="p">.</span><span class="nx">icon</span>
            <span class="k">onClicked:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">tune</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">stationID</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Now we can use the panel from the outside and create the service one layer on top. As we saw in the singleton refactoring we then can introduce a store to wrap the service even further.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">/// TunerView.qml</span>
<span class="nx">View</span> <span class="p">{</span>
    <span class="nx">StationService</span> <span class="p">{</span>
        <span class="kd">id: service</span>
    <span class="p">}</span>
    <span class="nx">StationPanel</span> <span class="p">{</span>
        <span class="k">stations:</span> <span class="nx">service</span><span class="p">.</span><span class="nx">stations</span>
        <span class="k">on:</span> <span class="nx">visible</span> <span class="o">&amp;&amp;</span> <span class="nx">service</span><span class="p">.</span><span class="nx">on</span>
        <span class="k">onTune:</span> <span class="nx">service</span><span class="p">.</span><span class="nx">tune</span><span class="p">(</span><span class="nx">stationID</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="recipe-convert-component-to-kinds">Recipe: Convert Component to Kinds</h3>
<p>A kind of component is a component which fits into a category. For this the component needs to be moved to a kind folder where all components of the same kind and which similar dependencies are collected. Ideally you start with the edge nodes and convert them to controls or panels.</p>
<p>We define initial the following components: <code>Control</code>, <code>Panel</code>, <code>View</code>, <code>Store</code>. You might decide that other kind of components are required, than these should be documented as with the purpose as also typical external dependencies.</p>
<p>In short, a control is a reusable visual item, which is not application specific. A panel is a container of controls or other panels. A view depends on a store and contains other panels or views. A store is a logical object, which can contain child stores.</p>
<p>Based on this, we need to create a set of folders and start sorting these components into the kind folders.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>controls/
panels/
views/
stores/
Main.qml
</pre></div>
</td></tr></table>

<p>It is advisable only to move a component into the kind folder after it has been cleaned up. Ideally you start with controls first and then panels, then views and stores. The strategy is to work from the UI tree from the edges towards the internal nodes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Be sure to only move components which follow the dependency guidelines, otherwise it is better to first eliminate of push up the harmful dependencies before moving the component.</p>
</div>
<h3 id="recipe-extract-a-store">Recipe: Extract a Store</h3>
<p>After pushing conditions up to the root level of the current component sometimes it is a good practice to collect them into an object. So the object gets injected into this component. This component is the first version of a potential store.</p>
<p>This object then collects these dependencies and will carry the harmful dependencies. The component itself will only depend on this particular object (aka store).</p>
<p>This makes it also easier to push dependencies up the UI tree as we only have to push the object up not individual properties.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// AppPanel.qml</span>
<span class="kr">import</span> <span class="nx">service</span><span class="p">.</span><span class="nx">time</span> <span class="mf">1.0</span>

<span class="nx">Panel</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="nx">property</span> <span class="nx">Clock</span> <span class="k">clock :</span> <span class="nx">Clock</span> <span class="p">{</span> <span class="p">}</span>
    <span class="nx">property</span> <span class="nx">string</span> <span class="nx">stationName</span>
    <span class="nx">TitlePanel</span> <span class="p">{</span>
        <span class="k">title:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">stationName</span>
        <span class="k">currentTime:</span> <span class="nx">clock</span><span class="p">.</span><span class="nx">currentTime</span>
    <span class="p">}</span>
    <span class="nx">ContentPanel</span> <span class="p">{</span>
        <span class="k">currentTime:</span> <span class="nx">clock</span><span class="p">.</span><span class="nx">currentTime</span>
        <span class="k">onResetTime:</span> <span class="nx">clock</span><span class="p">.</span><span class="nx">resetTime</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p><strong>Step: name space your dependency</strong></p>
<p>We create a new object called AppStore. This object shall wrap the dependencies.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="gi">+ // AppStore.qml</span>
<span class="gi">+ import service.time 1.0</span>
<span class="gi">+</span>
<span class="gi">+ Store {</span>
<span class="gi">+     property Clock clock: Clock {}</span>
<span class="gi">+ }</span>
</pre></div>
</td></tr></table>

<p>Now we can replace the direct dependencies with indirect dependencies using the new used store object. So practically name spacing the dependencies.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// AppPanel.qml
<span class="gd">- import service.time 1.0</span>

Panel {
    id: root
<span class="gd">-   property Clock clock : Clock { }</span>
<span class="gi">+   property AppStore store: AppStore {}</span>
    property string stationName
    TitlePanel {
        title: root.stationName
<span class="gd">-       currentTime: clock.currentTime</span>
<span class="gi">+       currentTime: store.clock.currentTime</span>
    }
    ContentPanel {
<span class="gi">+       currentTime: clock.currentTime</span>
<span class="gi">+       currentTime: store.clock.currentTime</span>
<span class="gd">-       onResetTime: clock.resetTime()</span>
<span class="gi">+       onResetTime: store.clock.resetTime()</span>
    }
}
</pre></div>
</td></tr></table>

<p>In the next step this will allow us now to do the trick and remove the dependencies from our panels.</p>
<p><strong>Step: Prevent object leaking</strong></p>
<p>We still have a problem in the store, we leak an object and the internals of the object can be discovered. We could prevent it by hiding the object behind the store interface.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// AppStore.qml
import service.time 1.0

Store {
<span class="gd">-   property Clock clock: Clock {}</span>
<span class="gi">+   property Clock __clock: Clock {}</span>

<span class="gi">+   property string currentTime: __clock.currentTime</span>
<span class="gi">+   function resetTime() {</span>
<span class="gi">+       __clock.resetTime()</span>
<span class="gi">+   }</span>
}
</pre></div>
</td></tr></table>

<p>This will change our panel in a way that it only depends on properties, signals or functions of the store and the store is able to conceal its internals.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// AppPanel.qml

Panel {
    id: root
    property AppStore store: AppStore {}
    property string stationName
    TitlePanel {
        title: root.stationName
<span class="gd">-       currentTime: store.clock.currentTime</span>
<span class="gi">+       currentTime: store.currentTime</span>
    }
    ContentPanel {
<span class="gd">-       currentTime: store.clock.currentTime</span>
<span class="gi">+       currentTime: store.clock.currentTime</span>
<span class="gd">-       onResetTime: store.clock.resetTime()</span>
<span class="gi">+       onResetTime: store.clock.resetTime()</span>
    }
}
</pre></div>
</td></tr></table>

<p><strong>Step: extract data interface into a data object</strong></p>
<p>Now we can also add the remaining station name, which might come from another service. The relevant part is it is not a visual property it is a data property, and as such should be contained inside the data store.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// AppStore.qml
import service.time 1.0

Store {
    property Clock clock: Clock {}
<span class="gi">+   property string stationName</span>
}
</pre></div>
</td></tr></table>

<p>Now the panel does not use the name property anymore it gets the information from the store.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// AppPanel.qml

Panel {
    id: root
<span class="gd">-   property AppStore store: AppStore {}</span>
<span class="gi">+   property AppStore store: AppStore {</span>
<span class="gi">+       stationName: root.stationName</span>
<span class="gi">+   }</span>
    property string stationName
    TitlePanel {
<span class="gd">-       title: root.stationName</span>
<span class="gi">+       title: store.stationName</span>
        currentTime: store.clock.currentTime
    }
    ContentPanel {
        currentTime: store.clock.currentTime
        onResetTime: store.clock.resetTime()
    }
}
</pre></div>
</td></tr></table>

<p>On the first sight this seems to make thing more complicated. But think about, we want to inject dependency. So we want to make it the duty of the instance which instantiates us to think about where the data comes from.</p>
<p>As the panel does now solely depend on the store for its data, testing the panel also now gets much more easier as also passing on the data between parts its now easier. To test now the business side, we can simple test the none visual store.</p>
<p><strong>Step: inject store</strong></p>
<p>So this allows us now to inject the store as dependency and make our dependency much more clearer.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// AppPanel.qml
// import service.time 1.0

Panel {
    id: root
<span class="gd">-   property AppStore store: AppStore {</span>
<span class="gd">-       stationName: root.stationName</span>
<span class="gd">-   }</span>
<span class="gd">-   property string stationName</span>
<span class="gi">+   property AppStore store</span>
    TitlePanel {
        title: store.stationName
        currentTime: store.clock.currentTime
    }
    ContentPanel {
        currentTime: store.clock.currentTime
        onResetTime: store.clock.resetTime()
    }
}
</pre></div>
</td></tr></table>

<p>We would call this component now a View (from View in <a href="https://en.wikipedia.org/wiki/Model–view–viewmodel">Model-View-ViewModel</a> pattern), as it depends on a store. A panels just depend on data properties, a view on a store.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="gd">- // AppPanel.qml</span>
<span class="gi">+ // AppView.qml</span>

<span class="gd">- Panel {</span>
<span class="gi">+ View {</span>
    id: root
    property AppStore store
    ...
}
</pre></div>
</td></tr></table>

<p>Maybe our AppPanel is called by a Main item, this would be the change there.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>// Main.qml
Item {
    width: 800
    height: 600
    AppPanel {
<span class="gd">-       stationName: &#39;Last Station&#39;</span>
<span class="gi">+       store: AppStore {</span>
<span class="gi">+           stationName: &#39;Last Station&#39;</span>
<span class="gi">+       }</span>
    }
}
</pre></div>
</td></tr></table>

<h2 id="conclusion">Conclusion</h2>
<p>Injecting dependencies, means roughly: make it the problem of the object calling you. When looking back we have now a set of nice to test components and clear idea where the data comes from.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Main.qml</span>
<span class="nx">Item</span> <span class="p">{</span>
    <span class="k">width:</span> <span class="mi">800</span>
    <span class="k">height:</span> <span class="mi">600</span>
    <span class="nx">AppPanel</span> <span class="p">{</span>
        <span class="k">store:</span> <span class="nx">AppStore</span> <span class="p">{</span>
            <span class="k">stationName:</span> <span class="s1">&#39;Last Station&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// AppStore.qml</span>
<span class="kr">import</span> <span class="nx">service</span><span class="p">.</span><span class="nx">time</span> <span class="mf">1.0</span>

<span class="nx">Store</span> <span class="p">{</span>
    <span class="nx">property</span> <span class="nx">Clock</span> <span class="nx">__clock</span><span class="o">:</span> <span class="nx">Clock</span> <span class="p">{}</span>
    <span class="nx">property</span> <span class="nx">string</span> <span class="nx">stationName</span>
    <span class="nx">property</span> <span class="nx">string</span> <span class="k">currentTime:</span> <span class="nx">__clock</span><span class="p">.</span><span class="nx">currentTime</span>
    <span class="kd">function</span> <span class="nx">resetTime</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">__clock</span><span class="p">.</span><span class="nx">resetTime</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// AppView.qml</span>
<span class="nx">View</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="nx">property</span> <span class="nx">AppStore</span> <span class="nx">store</span>
    <span class="nx">TitlePanel</span> <span class="p">{</span>
        <span class="k">title:</span> <span class="nx">store</span><span class="p">.</span><span class="nx">stationName</span>
        <span class="k">currentTime:</span> <span class="nx">store</span><span class="p">.</span><span class="nx">currentTime</span>
    <span class="p">}</span>
    <span class="nx">ContentPanel</span> <span class="p">{</span>
        <span class="k">currentTime:</span> <span class="nx">store</span><span class="p">.</span><span class="nx">currentTime</span>
        <span class="k">onResetTime:</span> <span class="nx">store</span><span class="p">.</span><span class="nx">resetTime</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// ContentPanel.qml</span>
<span class="nx">Panel</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="nx">property</span> <span class="nx">string</span> <span class="nx">currentTime</span>
    <span class="nx">signal</span> <span class="nx">resetTime</span><span class="p">()</span>

    <span class="nx">Button</span> <span class="p">{</span>
        <span class="k">text:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">currentTime</span>
        <span class="k">onClicked:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">resetTime</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// TitlePanel.qml</span>
<span class="nx">Panel</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="nx">property</span> <span class="nx">string</span> <span class="nx">currentTime</span>
    <span class="nx">Label</span> <span class="p">{</span>
        <span class="k">text:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">currentTime</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../uilayer/" title="UI Layer" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                UI Layer
              </span>
            </div>
          </a>
        
        
          <a href="../styles/" title="Styles" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Styles
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            2019 Luxoft GmbH
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>